{% comment %}
  Bunnings-style Header Section
  A custom header with green background, left logo, center search, and right account/cart elements
{% endcomment %}

{%- liquid
  assign header_id = 'bunnings-header-' | append: section.id
  assign search_id = 'search-input-' | append: section.id
-%}

<header 
  id="{{ header_id }}" 
  class="bunnings-header bunnings-header--{{ section.settings.section_width | default: 'page-width' }}"
  data-section-id="{{ section.id }}"
  style="
    --header-bg-color: {{ section.settings.background_color }};
    --header-text-color: {{ section.settings.text_color }};
    --header-hover-color: {{ section.settings.hover_color }};
    --search-bg-color: {{ section.settings.search_background }};
    --search-text-color: {{ section.settings.search_text_color }};
    --search-border-color: {{ section.settings.search_border_color }};
    --header-height: {{ section.settings.header_height }}px;
    --logo-width: {{ section.settings.logo_width }}px;
    --header-padding-top: {{ section.settings.padding_top }}px;
    --header-padding-bottom: {{ section.settings.padding_bottom }}px;
    --header-border-width: {{ section.settings.border_width }}px;
    --header-border-color: {{ section.settings.border_color }};
  "
>
  <div class="bunnings-header__container">
    {%- comment -%} Logo Section {%- endcomment -%}
    <div class="bunnings-header__logo">
      <a 
        href="{{ routes.root_url }}" 
        class="bunnings-header__logo-link"
        aria-label="{{ shop.name }} - Home"
      >
        {%- if settings.logo != blank -%}
          {%- assign logo_alt = settings.logo.alt | default: shop.name | escape -%}
          {{ settings.logo | image_url: width: section.settings.logo_width | image_tag:
            class: 'bunnings-header__logo-image',
            widths: '50, 100, 150, 200, 250',
            height: section.settings.logo_height,
            width: section.settings.logo_width,
            alt: logo_alt
          }}
        {%- else -%}
          <span class="bunnings-header__logo-text">{{ shop.name }}</span>
        {%- endif -%}
      </a>
    </div>

    {%- comment -%} Search Section {%- endcomment -%}
    <div class="bunnings-header__search">
      <form 
        action="{{ routes.search_url }}" 
        method="get" 
        role="search" 
        class="bunnings-search-form"
      >
        <div class="bunnings-search__wrapper">
          <label for="{{ search_id }}" class="visually-hidden">
            Search
          </label>
          
          <div class="bunnings-search__input-wrapper">
            <input
              type="search"
              id="{{ search_id }}"
              name="q"
              value="{{ search.terms | escape }}"
              placeholder="{{ section.settings.search_placeholder | default: 'What can we help you find today?' }}"
              class="bunnings-search__input"
              aria-label="Search"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
              data-predictive-search-input
            >
            
            <button 
              type="submit" 
              class="bunnings-search__button"
              aria-label="Search"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          {%- comment -%} Search Dropdown Container {%- endcomment -%}
          <div 
            class="bunnings-search__dropdown"
            data-search-dropdown
            style="display: none;"
          >
            <div class="bunnings-search__dropdown-inner">
              {%- comment -%} Recent Searches Section {%- endcomment -%}
              <div class="bunnings-search__recent" data-recent-searches style="display: none;">
                <div class="bunnings-search__section-header">
                  <h3 class="bunnings-search__section-title">Recent searches</h3>
                  <button 
                    type="button" 
                    class="bunnings-search__close-btn"
                    data-close-search
                    aria-label="Close search"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                      <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                </div>
                <ul class="bunnings-search__recent-list" data-recent-list>
                  <!-- Recent searches will be populated here -->
                </ul>
                <button 
                  type="button" 
                  class="bunnings-search__clear-recent"
                  data-clear-recent
                >
                  Clear recent searches
                </button>
              </div>

              {%- comment -%} Popular Products Section {%- endcomment -%}
              <div class="bunnings-search__popular" data-popular-section>
                <h3 class="bunnings-search__section-title">Popular right now</h3>
                <div class="bunnings-search__popular-items">
                  {%- for i in (1..4) -%}
                    {%- assign product_handle_key = 'popular_product_' | append: i -%}
                    {%- assign product_handle = section.settings[product_handle_key] -%}
                    {%- if product_handle != blank -%}
                      {%- assign product = all_products[product_handle] -%}
                      {%- if product != blank -%}
                        <a href="{{ product.url }}" class="bunnings-search__popular-item">
                          {%- if product.featured_image -%}
                            <div class="bunnings-search__popular-image">
                              {{ product.featured_image | image_url: width: 100 | image_tag:
                                loading: 'lazy',
                                alt: product.title
                              }}
                            </div>
                          {%- endif -%}
                          <div class="bunnings-search__popular-content">
                            <h4 class="bunnings-search__popular-title">{{ product.title }}</h4>
                            <div class="bunnings-search__popular-meta">
                              {%- if product.metafields.custom.category != blank -%}
                                <span class="bunnings-search__popular-category">
                                  {{ product.metafields.custom.category }}
                                </span>
                              {%- endif -%}
                              {%- for collection in product.collections limit: 2 -%}
                                {%- unless forloop.first -%}<span class="bunnings-search__separator">|</span>{%- endunless -%}
                                <span class="bunnings-search__popular-collection">
                                  {{ collection.title }}
                                </span>
                              {%- endfor -%}
                            </div>
                          </div>
                        </a>
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              </div>

              {%- comment -%} Search Results Section (hidden initially) {%- endcomment -%}
              <div class="bunnings-search__results" data-search-results style="display: none;">
                <!-- Search results will be populated here -->
              </div>
            </div>
          </div>
        </div>

        {%- if section.settings.show_popular_searches -%}
          <div class="bunnings-search__popular">
            <span class="bunnings-search__popular-label">{{ section.settings.popular_searches_text }}:</span>
            {%- for i in (1..5) -%}
              {%- assign search_key = 'popular_search_' | append: i -%}
              {%- assign search_term = section.settings[search_key] -%}
              {%- if search_term != blank -%}
                <a href="{{ routes.search_url }}?q={{ search_term | url_encode }}" class="bunnings-search__popular-link">
                  {{ search_term }}
                </a>
              {%- endif -%}
            {%- endfor -%}
          </div>
        {%- endif -%}
      </form>
    </div>

    {%- comment -%} Account & Cart Section {%- endcomment -%}
    <div class="bunnings-header__actions">
      {%- if shop.customer_accounts_enabled -%}
        <div class="bunnings-header__account">
          <a 
            href="{% if customer %}{{ routes.account_url }}{% else %}{{ routes.account_login_url }}{% endif %}"
            class="bunnings-header__action-link"
            aria-label="{% if customer %}Account{% else %}Sign in{% endif %}"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="bunnings-header__icon">
              <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="bunnings-header__action-text">
              {% if customer %}
                Account
              {% else %}
                Sign in
              {% endif %}
            </span>
          </a>
        </div>
      {%- endif -%}

      {%- if section.settings.show_lists -%}
        <div class="bunnings-header__lists">
          <a 
            href="{{ section.settings.lists_url | default: '/pages/lists' }}"
            class="bunnings-header__action-link"
            aria-label="{{ section.settings.lists_text | default: 'Lists' }}"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="bunnings-header__icon">
              <line x1="8" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="8" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="8" y1="18" x2="21" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="3" y1="6" x2="3.01" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="3" y1="12" x2="3.01" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="3" y1="18" x2="3.01" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="bunnings-header__action-text">{{ section.settings.lists_text | default: 'Lists' }}</span>
          </a>
        </div>
      {%- endif -%}

      <div class="bunnings-header__cart">
        <a 
          href="{{ routes.cart_url }}"
          class="bunnings-header__action-link bunnings-header__cart-link"
          aria-label="Cart - {{ cart.item_count }} {% if cart.item_count == 1 %}item{% else %}items{% endif %}"
          data-cart-count="{{ cart.item_count }}"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="bunnings-header__icon">
            <circle cx="9" cy="21" r="1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="20" cy="21" r="1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M1 1H5L7.68 14.39C7.77144 14.8504 8.02191 15.264 8.38755 15.5583C8.75318 15.8526 9.2107 16.009 9.68 16H19.4C19.8693 16.009 20.3268 15.8526 20.6925 15.5583C21.0581 15.264 21.3086 14.8504 21.4 14.39L23 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="bunnings-header__action-text">Cart</span>
          {%- if cart.item_count > 0 -%}
            <span class="bunnings-header__cart-count" aria-hidden="true">{{ cart.item_count }}</span>
          {%- endif -%}
        </a>
      </div>
    </div>
  </div>
</header>

<style>
  .bunnings-header {
    background-color: var(--header-bg-color);
    color: var(--header-text-color);
    width: 100%;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding-top: var(--header-padding-top, 0);
    padding-bottom: var(--header-padding-bottom, 0);
    border-bottom: var(--header-border-width, 0) solid var(--header-border-color, transparent);
  }

  .bunnings-header__container {
    display: flex;
    align-items: center;
    gap: 2rem;
    height: var(--header-height);
  }

  /* Page width container - default */
  .bunnings-header--page-width .bunnings-header__container {
    max-width: min(var(--page-width, 1400px), 100%);
    margin: 0 auto;
    padding: 0 max(1rem, calc((100vw - var(--page-width, 1400px)) / 2));
  }

  /* Full width container */
  .bunnings-header--full-width .bunnings-header__container {
    width: 100%;
    padding: 0 2rem;
    max-width: none;
  }

  @media screen and (min-width: 750px) {
    .bunnings-header--page-width .bunnings-header__container {
      padding: 0 2rem;
    }
    
    .bunnings-header--full-width .bunnings-header__container {
      padding: 0 4rem;
    }
  }

  @media screen and (min-width: 1400px) {
    .bunnings-header--full-width .bunnings-header__container {
      padding: 0 5rem;
    }
  }

  /* Logo Section */
  .bunnings-header__logo {
    flex-shrink: 0;
  }

  .bunnings-header__logo-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: var(--header-text-color);
  }

  .bunnings-header__logo-image {
    width: var(--logo-width);
    height: auto;
    display: block;
  }

  .bunnings-header__logo-text {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--header-text-color);
  }

  /* Search Section */
  .bunnings-header__search {
    flex-grow: 1;
    max-width: 600px;
  }

  .bunnings-search-form {
    width: 100%;
  }

  .bunnings-search__wrapper {
    position: relative;
  }

  .bunnings-search__input-wrapper {
    display: flex;
    align-items: center;
    background-color: var(--search-bg-color);
    border-radius: 25px;
    overflow: hidden;
    border: 2px solid var(--search-border-color);
    transition: border-color 0.2s ease;
  }

  .bunnings-search__input-wrapper:focus-within {
    border-color: var(--header-hover-color);
  }

  .bunnings-search__input {
    flex-grow: 1;
    padding: 0.75rem 1.25rem;
    border: none;
    background: transparent;
    color: var(--search-text-color);
    font-size: 1rem;
    outline: none;
  }

  .bunnings-search__input::placeholder {
    color: var(--search-text-color);
    opacity: 0.7;
  }

  .bunnings-search__button {
    background: none;
    border: none;
    padding: 0.75rem 1.25rem;
    cursor: pointer;
    color: var(--search-text-color);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
  }

  .bunnings-search__button:hover {
    opacity: 0.8;
  }

  /* Search Dropdown Container */
  .bunnings-search__dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    max-height: 600px;
    overflow-y: auto;
    z-index: 1000;
  }

  .bunnings-search__dropdown-inner {
    padding: 0;
  }

  /* Section Headers */
  .bunnings-search__section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem 0.5rem;
    border-bottom: 1px solid #e0e0e0;
  }

  .bunnings-search__section-title {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  .bunnings-search__close-btn {
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    color: #666;
    transition: color 0.2s ease;
  }

  .bunnings-search__close-btn:hover {
    color: #333;
  }

  /* Recent Searches */
  .bunnings-search__recent {
    border-bottom: 1px solid #e0e0e0;
  }

  .bunnings-search__recent-list {
    list-style: none;
    margin: 0;
    padding: 0.5rem 0;
  }

  .bunnings-search__recent-item {
    margin: 0;
  }

  .bunnings-search__recent-link {
    display: block;
    padding: 0.75rem 1.5rem;
    color: #333;
    text-decoration: none;
    transition: background-color 0.2s ease;
  }

  .bunnings-search__recent-link:hover {
    background-color: #f5f5f5;
  }

  .bunnings-search__clear-recent {
    display: block;
    width: 100%;
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    text-align: left;
    color: #666;
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-top: 1px solid #e0e0e0;
  }

  .bunnings-search__clear-recent:hover {
    background-color: #f5f5f5;
    color: #333;
  }

  /* Popular Products */
  .bunnings-search__popular {
    padding: 1rem 1.5rem;
  }

  .bunnings-search__popular .bunnings-search__section-title {
    margin-bottom: 1rem;
  }

  .bunnings-search__popular-items {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .bunnings-search__popular-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    text-decoration: none;
    color: #333;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    transition: all 0.2s ease;
  }

  .bunnings-search__popular-item:hover {
    background-color: #f5f5f5;
    border-color: #ccc;
  }

  .bunnings-search__popular-image {
    width: 60px;
    height: 60px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f9f9f9;
    border-radius: 4px;
    overflow: hidden;
  }

  .bunnings-search__popular-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .bunnings-search__popular-content {
    flex-grow: 1;
    min-width: 0;
  }

  .bunnings-search__popular-title {
    font-size: 0.875rem;
    font-weight: 500;
    margin: 0 0 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .bunnings-search__popular-meta {
    font-size: 0.75rem;
    color: #666;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .bunnings-search__separator {
    color: #ccc;
  }

  /* Search Results */
  .bunnings-search__results {
    padding: 1rem;
  }

  /* Popular Searches */
  .bunnings-search__popular {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--header-text-color);
    opacity: 0.9;
  }

  .bunnings-search__popular-label {
    opacity: 0.7;
  }

  .bunnings-search__popular-link {
    color: var(--header-text-color);
    text-decoration: underline;
    transition: opacity 0.2s ease;
  }

  .bunnings-search__popular-link:hover {
    opacity: 0.8;
  }

  /* Account & Cart Section */
  .bunnings-header__actions {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-shrink: 0;
  }

  .bunnings-header__action-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--header-text-color);
    text-decoration: none;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
    position: relative;
  }

  .bunnings-header__action-link:hover {
    background-color: var(--header-hover-color);
  }

  .bunnings-header__icon {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
  }

  .bunnings-header__action-text {
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
  }

  /* Cart Count Badge */
  .bunnings-header__cart-link {
    position: relative;
  }

  .bunnings-header__cart-count {
    position: absolute;
    top: 0;
    right: 0;
    background-color: #ff6b00;
    color: white;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.125rem 0.375rem;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
  }

  /* Mobile Responsive */
  @media screen and (max-width: 749px) {
    .bunnings-header__container {
      padding: 0 0.5rem;
      gap: 1rem;
    }

    .bunnings-header__logo {
      --logo-width: 120px;
    }

    .bunnings-header__search {
      display: none; /* Hide search on mobile - can be toggled */
    }

    .bunnings-header__action-text {
      display: none; /* Hide text labels on mobile */
    }

    .bunnings-header__actions {
      gap: 0.5rem;
    }

    .bunnings-header__cart-count {
      top: -4px;
      right: -4px;
    }
  }

  /* Visually Hidden Helper */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.querySelector('.bunnings-search-form');
    const searchInput = document.querySelector('[data-predictive-search-input]');
    const searchDropdown = document.querySelector('[data-search-dropdown]');
    const searchResults = document.querySelector('[data-search-results]');
    const recentSection = document.querySelector('[data-recent-searches]');
    const popularSection = document.querySelector('[data-popular-section]');
    const recentList = document.querySelector('[data-recent-list]');
    const clearRecentBtn = document.querySelector('[data-clear-recent]');
    const closeBtn = document.querySelector('[data-close-search]');
    
    let searchTimeout;
    const RECENT_SEARCHES_KEY = 'bunnings_recent_searches';
    const MAX_RECENT_SEARCHES = 5;

    // Get recent searches from localStorage
    function getRecentSearches() {
      try {
        return JSON.parse(localStorage.getItem(RECENT_SEARCHES_KEY)) || [];
      } catch (e) {
        return [];
      }
    }

    // Save recent search
    function saveRecentSearch(query) {
      if (!query || query.length < 2) return;
      
      let searches = getRecentSearches();
      // Remove if already exists
      searches = searches.filter(s => s.toLowerCase() !== query.toLowerCase());
      // Add to beginning
      searches.unshift(query);
      // Keep only max number
      searches = searches.slice(0, MAX_RECENT_SEARCHES);
      
      localStorage.setItem(RECENT_SEARCHES_KEY, JSON.stringify(searches));
    }

    // Display recent searches
    function displayRecentSearches() {
      const searches = getRecentSearches();
      
      if (searches.length === 0) {
        recentSection.style.display = 'none';
        return;
      }
      
      recentList.innerHTML = searches.map(search => `
        <li class="bunnings-search__recent-item">
          <a href="${window.Shopify.routes.root}search?q=${encodeURIComponent(search)}" 
             class="bunnings-search__recent-link"
             data-search-term="${search}">
            ${search}
          </a>
        </li>
      `).join('');
      
      recentSection.style.display = 'block';
    }

    // Show dropdown on focus
    searchInput.addEventListener('focus', function() {
      const query = this.value.trim();
      
      if (query.length < 2) {
        // Show recent searches and popular items
        displayRecentSearches();
        if (popularSection) popularSection.style.display = 'block';
        if (searchResults) searchResults.style.display = 'none';
      }
      
      searchDropdown.style.display = 'block';
    });

    // Handle search input
    searchInput.addEventListener('input', function(e) {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();

      if (query.length < 2) {
        // Show recent searches and popular items
        displayRecentSearches();
        if (popularSection) popularSection.style.display = 'block';
        if (searchResults) searchResults.style.display = 'none';
        return;
      }

      // Hide recent and popular, show loading or perform search
      if (recentSection) recentSection.style.display = 'none';
      if (popularSection) popularSection.style.display = 'none';
      
      // Debounce search
      searchTimeout = setTimeout(() => {
        performPredictiveSearch(query);
      }, 300);
    });

    // Handle form submit
    searchForm.addEventListener('submit', function(e) {
      const query = searchInput.value.trim();
      if (query) {
        saveRecentSearch(query);
      }
    });

    // Handle recent search click
    document.addEventListener('click', function(e) {
      const recentLink = e.target.closest('[data-search-term]');
      if (recentLink) {
        e.preventDefault();
        const searchTerm = recentLink.dataset.searchTerm;
        searchInput.value = searchTerm;
        searchForm.submit();
      }
    });

    // Clear recent searches
    if (clearRecentBtn) {
      clearRecentBtn.addEventListener('click', function() {
        localStorage.removeItem(RECENT_SEARCHES_KEY);
        recentSection.style.display = 'none';
      });
    }

    // Close button
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        searchDropdown.style.display = 'none';
        searchInput.blur();
      });
    }

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.bunnings-search__wrapper')) {
        searchDropdown.style.display = 'none';
      }
    });

    // Handle escape key
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        searchDropdown.style.display = 'none';
        searchInput.blur();
      }
    });

    // Predictive search function
    function performPredictiveSearch(query) {
      const searchUrl = `${window.Shopify.routes.root}search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product,collection,page&resources[limit]=5`;

      fetch(searchUrl)
        .then(response => response.json())
        .then(data => {
          displaySearchResults(data);
        })
        .catch(error => {
          console.error('Search error:', error);
        });
    }

    // Display search results
    function displaySearchResults(data) {
      if (!searchResults) return;
      
      if (!data.resources || !data.resources.results) {
        searchResults.style.display = 'none';
        return;
      }

      let html = '';

      // Products
      if (data.resources.results.products && data.resources.results.products.length > 0) {
        html += '<div class="search-results__section">';
        html += '<h3 class="search-results__heading">Products</h3>';
        html += '<ul class="search-results__list">';
        
        data.resources.results.products.forEach(product => {
          html += `
            <li class="search-results__item">
              <a href="${product.url}" class="search-results__link">
                ${product.image ? `<img src="${product.image}" alt="${product.title}" class="search-results__image">` : ''}
                <div class="search-results__content">
                  <span class="search-results__title">${product.title}</span>
                  <span class="search-results__price">${product.price}</span>
                </div>
              </a>
            </li>
          `;
        });
        
        html += '</ul></div>';
      }

      // Collections
      if (data.resources.results.collections && data.resources.results.collections.length > 0) {
        html += '<div class="search-results__section">';
        html += '<h3 class="search-results__heading">Collections</h3>';
        html += '<ul class="search-results__list">';
        
        data.resources.results.collections.forEach(collection => {
          html += `
            <li class="search-results__item">
              <a href="${collection.url}" class="search-results__link">
                <span class="search-results__title">${collection.title}</span>
              </a>
            </li>
          `;
        });
        
        html += '</ul></div>';
      }

      if (html) {
        searchResults.innerHTML = html;
        searchResults.style.display = 'block';
      } else {
        searchResults.style.display = 'none';
      }
    }

    // Update cart count dynamically
    function updateCartCount() {
      fetch('/cart.js')
        .then(response => response.json())
        .then(data => {
          const cartLink = document.querySelector('[data-cart-count]');
          const cartCount = document.querySelector('.bunnings-header__cart-count');
          
          if (cartLink) {
            cartLink.setAttribute('data-cart-count', data.item_count);
            cartLink.setAttribute('aria-label', `Cart - ${data.item_count} items`);
          }
          
          if (cartCount) {
            if (data.item_count > 0) {
              cartCount.textContent = data.item_count;
              cartCount.style.display = 'block';
            } else {
              cartCount.style.display = 'none';
            }
          }
        });
    }

    // Listen for cart updates
    document.addEventListener('cart:updated', updateCartCount);
  });
</script>

<style>
  /* Search Results Styles */
  .search-results__section {
    margin-bottom: 1rem;
  }

  .search-results__section:last-child {
    margin-bottom: 0;
  }

  .search-results__heading {
    font-size: 0.875rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .search-results__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .search-results__item {
    border-bottom: 1px solid #e0e0e0;
  }

  .search-results__item:last-child {
    border-bottom: none;
  }

  .search-results__link {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 0;
    text-decoration: none;
    color: #333;
    transition: background-color 0.2s ease;
  }

  .search-results__link:hover {
    background-color: #f5f5f5;
    margin: 0 -1rem;
    padding-left: 1rem;
    padding-right: 1rem;
  }

  .search-results__image {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
  }

  .search-results__content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex-grow: 1;
  }

  .search-results__title {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .search-results__price {
    font-size: 0.875rem;
    color: #666;
  }
</style>

{% schema %}
{
  "name": "Bunnings Header",
  "tag": "section",
  "class": "bunnings-header-section",
  "settings": [
    {
      "type": "header",
      "content": "Logo"
    },
    {
      "type": "paragraph",
      "content": "Logo uses the global theme settings. To change the logo, go to Theme Settings > Logo."
    },
    {
      "type": "range",
      "id": "logo_width",
      "label": "Logo width",
      "min": 50,
      "max": 250,
      "step": 10,
      "default": 150,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "logo_height",
      "label": "Logo height",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Search"
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Search placeholder text",
      "default": "What can we help you find today?"
    },
    {
      "type": "checkbox",
      "id": "show_popular_searches",
      "label": "Show popular searches",
      "default": false
    },
    {
      "type": "text",
      "id": "popular_searches_text",
      "label": "Popular searches label",
      "default": "Popular searches"
    },
    {
      "type": "text",
      "id": "popular_search_1",
      "label": "Popular search 1"
    },
    {
      "type": "text",
      "id": "popular_search_2",
      "label": "Popular search 2"
    },
    {
      "type": "text",
      "id": "popular_search_3",
      "label": "Popular search 3"
    },
    {
      "type": "text",
      "id": "popular_search_4",
      "label": "Popular search 4"
    },
    {
      "type": "text",
      "id": "popular_search_5",
      "label": "Popular search 5"
    },
    {
      "type": "header",
      "content": "Popular Products"
    },
    {
      "type": "paragraph",
      "content": "Select products to show in the 'Popular right now' section when the search is focused."
    },
    {
      "type": "product",
      "id": "popular_product_1",
      "label": "Popular product 1"
    },
    {
      "type": "product",
      "id": "popular_product_2",
      "label": "Popular product 2"
    },
    {
      "type": "product",
      "id": "popular_product_3",
      "label": "Popular product 3"
    },
    {
      "type": "product",
      "id": "popular_product_4",
      "label": "Popular product 4"
    },
    {
      "type": "header",
      "content": "Actions"
    },
    {
      "type": "checkbox",
      "id": "show_lists",
      "label": "Show Lists link",
      "default": true
    },
    {
      "type": "text",
      "id": "lists_text",
      "label": "Lists link text",
      "default": "Lists"
    },
    {
      "type": "url",
      "id": "lists_url",
      "label": "Lists page URL"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#0d5257"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "hover_color",
      "label": "Hover background color",
      "default": "rgba(255, 255, 255, 0.1)"
    },
    {
      "type": "color",
      "id": "search_background",
      "label": "Search background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "search_text_color",
      "label": "Search text color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "search_border_color",
      "label": "Search border color",
      "default": "transparent"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Width",
      "options": [
        {
          "value": "page-width",
          "label": "Page width"
        },
        {
          "value": "full-width",
          "label": "Full width"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "header_height",
      "label": "Header height",
      "min": 60,
      "max": 120,
      "step": 10,
      "default": 80,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "border_width",
      "label": "Border bottom width",
      "min": 0,
      "max": 5,
      "step": 1,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#e0e0e0"
    }
  ],
  "presets": [
    {
      "name": "Bunnings Header",
      "settings": {
        "background_color": "#0d5257",
        "text_color": "#ffffff",
        "search_placeholder": "What can we help you find today?",
        "show_lists": true,
        "lists_text": "Lists"
      }
    }
  ]
}
{% endschema %}
